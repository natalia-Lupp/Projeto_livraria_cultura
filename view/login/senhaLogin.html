<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Senha</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="../../css/styleLogins.css" />
    <link rel="stylesheet" href="../../css/styleLogins.min.css" />
  </head>

  <body>
    <div
      class="container d-flex flex-column justify-content-center align-items-center"
      style="min-height: 100vh; max-width: 450px"
    >
      <h4 class="mb-3 text-center text-muted fw-bold w-100">
        CADASTRAR NOVA SENHA
      </h4>
      <hr class="linha-login text-secondary" />

      <form class="w-100">
        <!-- Nova Senha -->
        <div class="mb-3 text-start">
          <label for="novaSenha" class="form-label fw-bold">Nova Senha</label>
          <input
            type="password"
            class="form-control"
            id="novaSenha"
            placeholder="Digite sua nova senha"
          />
          <div id="erroNovaSenha" class="form-text text-danger"></div>
        </div>

        <!-- Confirmar Senha -->
        <div class="mb-3 text-start">
          <label for="confirmarSenha" class="form-label fw-bold">Confirmar senha</label>
          <input
            type="password"
            class="form-control"
            id="confirmarSenha"
            placeholder="Digite a senha novamente"
          />
          <div id="erroConfirmarSenha" class="form-text text-danger"></div>
        </div>

        <!-- Critérios -->
        <div class="mb-4 text-start text-secondary fw-semibold">
          Sua senha deve ter:
          <ul class="ps-3 mb-0">
            <li>Mínimo de 8 caracteres</li>
            <li>1 número</li>
            <li>1 letra minúscula</li>
            <li>1 letra maiúscula</li>
            <li>1 símbolo (ex: @, #, $, %, etc.)</li>
          </ul>
        </div>

        <!-- Mensagem de sucesso -->
        <div id="mensagemSucesso" class="alert alert-success d-none" role="alert">
          Senha cadastrada com sucesso!
        </div>

        <!-- Ações -->
        <div class="d-flex justify-content-between align-items-center px-0">
          <a href="login.html" class="text-decoration-none text-primary fw-bold">
            <i class="bi bi-arrow-left"></i> Voltar
          </a>
          <button
            type="button"
            class="btn btn-info fw-bold text-white"
            id="cadastrarSenha"
          >
            Cadastrar senha
          </button>
        </div>
      </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
      $(document).ready(function () {
        $("#cadastrarSenha").click(function (e) {
          e.preventDefault();

          // Limpa mensagens anteriores
          $("#erroNovaSenha").text("");
          $("#erroConfirmarSenha").text("");
          $("#mensagemSucesso").addClass("d-none").text("");

          const senha = $("#novaSenha").val().trim();
          const confirmar = $("#confirmarSenha").val().trim();

          const regexSenha = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/;

          let erro = false;

          if (!regexSenha.test(senha)) {
            $("#erroNovaSenha").text(
              "A senha deve ter no mínimo 8 caracteres, com 1 número, 1 maiúscula, 1 minúscula e 1 símbolo."
            );
            erro = true;
          }

          if (senha !== confirmar) {
            $("#erroConfirmarSenha").text("As senhas não coincidem.");
            erro = true;
          }

          if (erro) return;

          const queryString = window.location.search;
          const urlParams = new URLSearchParams(queryString);
          const email = urlParams.get("email");

          if (!email) {
            $("#erroNovaSenha").text("E-mail não encontrado.");
            return;
          }

          const user = JSON.parse(localStorage.getItem(email)) || {};
          user.senha = senha;
          localStorage.setItem(email, JSON.stringify(user));

          $("#mensagemSucesso").removeClass("d-none").text("Senha cadastrada com sucesso!");

          setTimeout(() => {
            window.location.href = "senhaEmailLogin.html";
          }, 1500);
        });
      });
    </script>
  </body>
</html>
